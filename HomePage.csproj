<Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">

  <PropertyGroup>
    <TargetFramework>net5.0</TargetFramework>
    <ServiceWorkerAssetsManifest>service-worker-assets.js</ServiceWorkerAssetsManifest>
    <PublishTrimmed>true</PublishTrimmed>
    <TrimMode>link</TrimMode>
    <RunPostBuildEvent>Always</RunPostBuildEvent>
  </PropertyGroup>

  <ItemGroup>
    <Content Remove="bundleconfig.json" />
  </ItemGroup>

  <ItemGroup>
    <None Include="bundleconfig.json" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Blazored.LocalStorage" Version="3.0.0" />
    <PackageReference Include="Markdig" Version="0.26.0" />
    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly" Version="5.0.1" />
    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.Authentication" Version="5.0.1" />
    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.DevServer" Version="5.0.1" PrivateAssets="all" />
    <PackageReference Include="Microsoft.AspNetCore.SignalR.Client" Version="5.0.7" />
    <PackageReference Include="Microsoft.Authentication.WebAssembly.Msal" Version="5.0.1" />
    <PackageReference Include="QRCoder" Version="1.4.1" />
    <PackageReference Include="Roman015ApiClient" Version="1.0.14" />
    <PackageReference Include="System.Net.Http.Json" Version="5.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ServiceWorker Include="wwwroot\service-worker.js" PublishedContent="wwwroot\service-worker.published.js" />
  </ItemGroup>

  <Target Name="PostBuild" AfterTargets="PostBuildEvent">
    <Exec Command="echo POST BUILD COMMANDS" />
    
    <Exec Command="echo BUILD OS : WINDOWS" Condition="'$(OS)' == 'Windows_NT'" />
    <Exec Command="echo BUILD OS : LINUX" Condition="'$(OS)' != 'Windows_NT'" />

    <Exec Command="cd $(TargetDir)" />
    <Exec Command="pwd" />
    
    <Exec Command="powershell -Command &quot;$txt=(Get-Content .\wwwroot\_framework\blazor.webassembly.js);$txt = $txt.Replace('return r.loadResource(o,t(o),e[o],n)','var p = r.loadResource(o,t(o),e[o],n); p.response.then((x) =&gt; { if (typeof window.loadResourceCallback === ''function'') { window.loadResourceCallback(Object.keys(e).length, o, x);}}); return p;'); Set-Content -Path  .\wwwroot\_framework\blazor.webassembly.js -Value $txt&quot;" Condition="'$(OS)' == 'Windows_NT' "/>    
    
    <Exec Command="sed -i 's/return\sr\.loadResource(o,t(o),e\[o\],n)/THIS_IS_A_TEST/g' ./_framework/blazor.webassembly.js" Condition="'$(OS)' != 'Windows_NT'"/>
    <Exec Command="echo COUNT &#xD;&#xA;&#xD;&#xA; cat ./_framework/blazor.webassembly.js | grep 'THIS_IS_A_TEST' -c &#xD;&#xA;&#xD;&#xA;echo END COUNT" Condition="'$(OS)' != 'Windows_NT'"/>
    
    <Exec Command="echo POST BUILD COMMANDS COMPLETED" />
  </Target>
  
  <Target Name="Test" AfterTargets="Publish">
    <Exec Command="echo AFTER PUBLISH COMMANDS" Condition="'$(OS)' != 'Windows_NT'" />

    <Exec Command="echo VALUES" Condition="'$(OS)' != 'Windows_NT'" />
    <Exec Command="echo $(TargetDir)" Condition="'$(OS)' != 'Windows_NT'" />
    <Exec Command="echo $(PublishDir)" Condition="'$(OS)' != 'Windows_NT'" />

    <Exec Command="echo START" Condition="'$(OS)' != 'Windows_NT'" />
    <Exec Command="pwd" Condition="'$(OS)' != 'Windows_NT'" />
    <Exec Command="cd $(TargetDir)" />
    <Exec Command="pwd" Condition="'$(OS)' != 'Windows_NT'" />
    <Exec Command="ls" Condition="'$(OS)' != 'Windows_NT'" />
    
    <Exec Command="sed -i 's/return\sr\.loadResource(o,t(o),e\[o\],n)/THIS_IS_A_TEST/g' ./wwwroot/_framework/blazor.webassembly.js" Condition="'$(OS)' != 'Windows_NT'"/>
    
    <Exec Command="echo AFTER PUBLISH COMMANDS COMPLETED" Condition="'$(OS)' != 'Windows_NT'" />
  </Target>

</Project>
